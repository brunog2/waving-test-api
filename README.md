# üõçÔ∏è Waving Test API

API REST para sistema de e-commerce desenvolvida com NestJS, PostgreSQL e Prisma.

## üöÄ Tecnologias

- **Backend:** NestJS
- **Banco de Dados:** PostgreSQL
- **ORM:** Prisma
- **Autentica√ß√£o:** JWT
- **Documenta√ß√£o:** Swagger/OpenAPI
- **Valida√ß√£o:** class-validator
- **Criptografia:** bcrypt

## üìã Pr√©-requisitos

- Node.js (vers√£o 18 ou superior)
- npm ou yarn
- PostgreSQL
- Docker (opcional, para rodar PostgreSQL)

## üõ†Ô∏è Instala√ß√£o

### 1. Clone o reposit√≥rio

```bash
git clone https://github.com/brunog2/waving-test-api
cd waving-test-api
```

### 2. Instale as depend√™ncias

```bash
npm install
```

### 3. Configure as vari√°veis de ambiente

Crie um arquivo `.env` na raiz do projeto:

```env
# Database
DB_HOST=localhost
DB_NAME=wt
DB_USER=postgres
DB_PASSWORD=postgres
DB_PORT=5432
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/wt?schema=public

# JWT
SECRET=sua-chave-secreta-aqui

# API
PORT=3000
```

### 4. Configure o banco de dados

#### Op√ß√£o A: Usando Docker (Recomendado)

```bash
# Inicia o PostgreSQL
docker compose -f docker-compose-dev.yml up -d
```

#### Op√ß√£o B: PostgreSQL local

Certifique-se de que o PostgreSQL est√° rodando e crie um banco de dados chamado `wt`.

## üóÑÔ∏è Configura√ß√£o do Banco de Dados

### 1. Gere o Prisma Client

```bash
npx prisma generate
```

### 2. Execute as migrations

```bash
npx prisma migrate dev
```

### 3. Popule o banco com dados de exemplo

```bash
npm run prisma:seed
```

## üöÄ Como Executar

### Desenvolvimento

```bash
# Modo desenvolvimento com watch
npm run start:dev

# Ou com servi√ßos Docker
npm run start:services
```

### Produ√ß√£o

```bash
# Build do projeto
npm run build

# Executar em produ√ß√£o
npm run start:prod
```

## üìã Vis√£o Geral do Projeto

API REST desenvolvida em **NestJS** com **Prisma ORM** e **PostgreSQL**, implementando um sistema de e-commerce completo com autentica√ß√£o JWT, controle de usu√°rios, produtos, categorias, carrinho de compras, pedidos e coment√°rios.

## üèóÔ∏è Arquitetura

### Tecnologias Utilizadas
- **Framework**: NestJS (Node.js)
- **ORM**: Prisma
- **Banco de Dados**: PostgreSQL
- **Autentica√ß√£o**: JWT (JSON Web Tokens)
- **Valida√ß√£o**: class-validator + class-transformer
- **Documenta√ß√£o**: Swagger/OpenAPI
- **Deploy**: Fly.io

### Estrutura do Projeto
```
src/
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ auth/           # Autentica√ß√£o e autoriza√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ users/          # Gest√£o de usu√°rios
‚îÇ   ‚îú‚îÄ‚îÄ categories/     # Categorias de produtos
‚îÇ   ‚îú‚îÄ‚îÄ products/       # Produtos
‚îÇ   ‚îú‚îÄ‚îÄ cart/          # Carrinho de compras
‚îÇ   ‚îú‚îÄ‚îÄ orders/        # Pedidos
‚îÇ   ‚îî‚îÄ‚îÄ comments/      # Coment√°rios
‚îú‚îÄ‚îÄ enums/             # Enums do sistema
‚îú‚îÄ‚îÄ config/            # Configura√ß√µes
‚îî‚îÄ‚îÄ prisma/            # Configura√ß√£o do Prisma
```

## üîê Sistema de Autentica√ß√£o

### Tipos de Usu√°rio
- **CUSTOMER**: Cliente comum (pode fazer compras)
- **ADMIN**: Administrador (acesso total ao sistema)

### Endpoints de Autentica√ß√£o
- `POST /auth/register` - Registro de cliente
- `POST /auth/login` - Login de cliente
- `POST /auth/admin/login` - Login de administrador

### Prote√ß√£o de Rotas
- **@UseGuards(JwtAuthGuard)**: Rotas protegidas por JWT
- **@UseGuards(AdminGuard)**: Rotas exclusivas para admin
- **@UseGuards(CustomerGuard)**: Rotas exclusivas para cliente

## üìä Modelos de Dados

### User
```typescript
{
  id: string
  email: string
  password: string (hasheada)
  name: string
  role: Role (CUSTOMER | ADMIN)
  createdAt: Date
  updatedAt: Date
}
```

### Category
```typescript
{
  id: string
  name: string
  description: string
  products: Product[]
}
```

### Product
```typescript
{
  id: string
  name: string
  description: string
  price: number
  stock: number
  categoryId: string
  category: Category
  cartItems: CartItem[]
  orderItems: OrderItem[]
}
```

### Cart & CartItem
```typescript
{
  id: string
  userId: string
  user: User
  items: CartItem[]
}

CartItem {
  id: string
  cartId: string
  productId: string
  quantity: number
  product: Product
}
```

### Order & OrderItem
```typescript
{
  id: string
  userId: string
  status: OrderStatus
  total: number
  items: OrderItem[]
  createdAt: Date
  updatedAt: Date
}

OrderStatus: PENDING | PROCESSING | SHIPPED | DELIVERED | CANCELLED
```

## üöÄ Endpoints da API

### Autentica√ß√£o
| M√©todo | Endpoint | Descri√ß√£o | Acesso |
|--------|----------|-----------|--------|
| POST | `/auth/register` | Registro de cliente | P√∫blico |
| POST | `/auth/login` | Login de cliente | P√∫blico |
| POST | `/auth/admin/login` | Login de admin | P√∫blico |

### Usu√°rios
| M√©todo | Endpoint | Descri√ß√£o | Acesso |
|--------|----------|-----------|--------|
| GET | `/users` | Listar usu√°rios | Admin |
| GET | `/users/profile` | Perfil do usu√°rio logado | Cliente |
| GET | `/users/:id` | Buscar usu√°rio por ID | Admin/Pr√≥prio |
| PATCH | `/users/:id` | Atualizar usu√°rio | Admin/Pr√≥prio |
| DELETE | `/users/:id` | Deletar usu√°rio | Admin |

### Categorias
| M√©todo | Endpoint | Descri√ß√£o | Acesso |
|--------|----------|-----------|--------|
| GET | `/categories` | Listar categorias | P√∫blico |
| GET | `/categories/all` | Listar todas categorias | P√∫blico |
| GET | `/categories/with-products` | Categorias com produtos | P√∫blico |
| GET | `/categories/:id` | Buscar categoria por ID | P√∫blico |
| POST | `/categories` | Criar categoria | Admin |
| PATCH | `/categories/:id` | Atualizar categoria | Admin |
| DELETE | `/categories/:id` | Deletar categoria | Admin |

### Produtos
| M√©todo | Endpoint | Descri√ß√£o | Acesso |
|--------|----------|-----------|--------|
| GET | `/products` | Listar produtos | P√∫blico |
| GET | `/products/:id` | Buscar produto por ID | P√∫blico |
| POST | `/products` | Criar produto | Admin |
| PATCH | `/products/:id` | Atualizar produto | Admin |
| DELETE | `/products/:id` | Deletar produto | Admin |

### Carrinho
| M√©todo | Endpoint | Descri√ß√£o | Acesso |
|--------|----------|-----------|--------|
| GET | `/cart` | Ver carrinho | Cliente |
| GET | `/cart/total` | Total do carrinho | Cliente |
| POST | `/cart/items` | Adicionar item | Cliente |
| POST | `/cart/items/bulk` | Adicionar m√∫ltiplos itens | Cliente |
| PATCH | `/cart/items/:id` | Atualizar quantidade | Cliente |
| DELETE | `/cart/items/:id` | Remover item | Cliente |
| DELETE | `/cart` | Limpar carrinho | Cliente |

### Pedidos
| M√©todo | Endpoint | Descri√ß√£o | Acesso |
|--------|----------|-----------|--------|
| GET | `/orders` | Listar pedidos | Admin/Pr√≥prios |
| GET | `/orders/:id` | Buscar pedido por ID | Admin/Pr√≥prio |
| POST | `/orders` | Criar pedido | Cliente |
| PATCH | `/orders/:id` | Atualizar status | Admin |
| DELETE | `/orders/:id` | Deletar pedido | Admin |
| GET | `/orders/dashboard/stats` | Estat√≠sticas | Admin |

### Coment√°rios
| M√©todo | Endpoint | Descri√ß√£o | Acesso |
|--------|----------|-----------|--------|
| GET | `/comments` | Listar coment√°rios | P√∫blico |
| POST | `/comments` | Criar coment√°rio | Cliente |

## üîß Configura√ß√µes

### Vari√°veis de Ambiente
```env
DATABASE_URL="postgresql://..."
JWT_SECRET="seu-jwt-secret"
PORT=3000
NODE_ENV=production
```

### Banco de Dados
- **PostgreSQL** com extens√£o `unaccent` para busca
- **Migrations** autom√°ticas no deploy
- **Seeds** para dados iniciais

## üöÄ Deploy

### Fly.io
- **URL**: https://waving-test-api.fly.dev
- **Documenta√ß√£o**: https://waving-test-api.fly.dev/api
- **Porta**: 3000 (padr√£o Fly.io)

### Processo de Deploy
1. Build multi-stage Docker
2. Execu√ß√£o autom√°tica de migrations
3. Execu√ß√£o autom√°tica de seeds
4. Inicializa√ß√£o da aplica√ß√£o

## üìù Funcionalidades Implementadas

### ‚úÖ Completas
- [x] Autentica√ß√£o JWT com roles (CUSTOMER/ADMIN)
- [x] CRUD completo de usu√°rios
- [x] CRUD completo de categorias
- [x] CRUD completo de produtos
- [x] Sistema de carrinho de compras
- [x] Sistema de pedidos com status
- [x] Sistema de coment√°rios
- [x] Valida√ß√£o de dados com class-validator
- [x] Documenta√ß√£o Swagger
- [x] Deploy automatizado no Fly.io
- [x] Seeds autom√°ticos
- [x] Health checks

### üîí Seguran√ßa
- [x] Senhas hasheadas com bcrypt
- [x] Autentica√ß√£o JWT
- [x] Autoriza√ß√£o por roles
- [x] Valida√ß√£o de entrada
- [x] Usu√°rio n√£o-root no Docker

### üìä Dados Iniciais
O sistema √© populado automaticamente com:
- Usu√°rio admin padr√£o
- Categorias de exemplo
- Produtos de exemplo
- Coment√°rios de exemplo

## üß™ Testes

### Endpoints de Teste
- `GET /api` - Documenta√ß√£o Swagger
- `GET /health` - Health check

### Credenciais de Teste
```
Admin:
- Email: adm@wt.com
- Senha: 123

Cliente:
- Email: customer@wt.com  
- Senha: 123
```

## üìö Documenta√ß√£o da API

A documenta√ß√£o completa est√° dispon√≠vel em:
**https://waving-test-api.fly.dev/api**

üîó **Documenta√ß√£o tamb√©m dispon√≠vel em:** [https://deepwiki.com/brunog2/waving-test-api](https://deepwiki.com/brunog2/waving-test-api)


Inclui:
- Todos os endpoints
- Schemas de request/response
- Exemplos de uso
- C√≥digos de erro
- Autentica√ß√£o

## üéØ Decis√µes de Arquitetura

### NestJS
- Framework robusto para APIs
- Arquitetura modular
- Inje√ß√£o de depend√™ncia
- Decorators para valida√ß√£o

### Prisma
- Type-safe ORM
- Migrations autom√°ticas
- Seeds integrados
- Relacionamentos bem definidos

### Fly.io
- Deploy simples
- Escalabilidade autom√°tica
- PostgreSQL integrado
- Health checks nativos

### Estrutura Modular
- Separa√ß√£o clara de responsabilidades
- Guards para autoriza√ß√£o
- DTOs para valida√ß√£o
- Interfaces bem definidas

## üîÑ Fluxo de Dados

1. **Cliente** faz login ‚Üí recebe JWT
2. **Cliente** navega produtos ‚Üí adiciona ao carrinho
3. **Cliente** finaliza compra ‚Üí cria pedido
4. **Admin** gerencia pedidos ‚Üí atualiza status
5. **Sistema** mant√©m hist√≥rico completo

Esta arquitetura garante:
- **Escalabilidade**: M√≥dulos independentes
- **Manutenibilidade**: C√≥digo bem estruturado
- **Seguran√ßa**: Autentica√ß√£o e autoriza√ß√£o robustas
- **Performance**: ORM otimizado e √≠ndices adequados 

## üìö Scripts Dispon√≠veis

```bash
# Desenvolvimento
npm run start:dev          # Executa em modo desenvolvimento com watch
npm run start:services     # Executa com Docker + desenvolvimento
npm run start:debug        # Executa em modo debug

# Produ√ß√£o
npm run build              # Compila o projeto
npm run start:prod         # Executa em produ√ß√£o

# Testes
npm run test               # Executa testes unit√°rios
npm run test:watch         # Executa testes em modo watch
npm run test:e2e           # Executa testes end-to-end
npm run test:cov           # Executa testes com cobertura

# Qualidade de c√≥digo
npm run lint               # Executa ESLint
npm run format             # Formata c√≥digo com Prettier

# Banco de dados
npm run prisma:seed        # Popula banco com dados de exemplo
npm run db:reset           # Reseta banco, migra√ß√µes e dados
npm run db:migrate         # Executa migra√ß√µes em desenvolvimento
npm run db:deploy          # Executa migra√ß√µes em produ√ß√£o
npm run db:studio          # Abre Prisma Studio
npm run db:generate        # Gera Prisma Client
npm run db:push            # Sincroniza schema com banco
npm run db:pull            # Puxa schema do banco
```

## üóÑÔ∏è Comandos do Prisma

```bash
# Gerar Prisma Client
npx prisma generate

# Criar nova migra√ß√£o
npx prisma migrate dev --name nome-da-migracao

# Aplicar migra√ß√µes em produ√ß√£o
npx prisma migrate deploy

# Resetar banco de dados
npx prisma migrate reset

# Abrir Prisma Studio (interface visual)
npx prisma studio

# Verificar status do banco
npx prisma db pull

# Gerar schema a partir do banco
npx prisma db push
```

## üìñ Documenta√ß√£o da API

Ap√≥s iniciar o servidor, acesse a documenta√ß√£o Swagger:

```
http://localhost:3000/api
```

## üîê Usu√°rios de Teste

Ap√≥s executar o seed, voc√™ ter√° os seguintes usu√°rios:

### Administrador

- **Email:** adm@wt.com
- **Senha:** 123
- **Role:** ADMIN

### Cliente

- **Email:** customer@wt.com
- **Senha:** 123
- **Role:** CUSTOMER

### Usu√°rios para Avalia√ß√µes

- john@example.com / 123
- jane@example.com / 123
- mike@example.com / 123
- sarah@example.com / 123
- david@example.com / 123

## üõ†Ô∏è Estrutura do Projeto

```
src/
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ auth/           # Autentica√ß√£o e autoriza√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ users/          # Gerenciamento de usu√°rios
‚îÇ   ‚îú‚îÄ‚îÄ categories/     # Categorias de produtos
‚îÇ   ‚îú‚îÄ‚îÄ products/       # Produtos
‚îÇ   ‚îú‚îÄ‚îÄ comments/       # Coment√°rios e avalia√ß√µes
‚îÇ   ‚îú‚îÄ‚îÄ cart/           # Carrinho de compras
‚îÇ   ‚îî‚îÄ‚îÄ orders/         # Pedidos
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma   # Schema do banco de dados
‚îÇ   ‚îú‚îÄ‚îÄ seed.ts         # Dados de exemplo
‚îÇ   ‚îî‚îÄ‚îÄ migrations/     # Migra√ß√µes do banco
‚îî‚îÄ‚îÄ config/             # Configura√ß√µes da aplica√ß√£o
```

## üîß Configura√ß√µes Importantes

### Vari√°veis de Ambiente

- `DB_HOST`: Host do banco de dados
- `DB_NAME`: Nome do banco de dados
- `DB_USER`: Usu√°rio do banco de dados
- `DB_PASSWORD`: Senha do banco de dados
- `DB_PORT`: Porta do banco de dados
- `DATABASE_URL`: URL completa de conex√£o com PostgreSQL
- `SECRET`: Chave secreta para JWT
- `PORT`: Porta da aplica√ß√£o

### Extens√µes PostgreSQL

O projeto utiliza a extens√£o `unaccent` para busca sem acentos. A migra√ß√£o √© aplicada automaticamente.

## üö® Troubleshooting

### Problemas com Prisma

```bash
# Se houver problemas com o Prisma Client
npx prisma generate

# Se houver problemas com migra√ß√µes
npx prisma migrate reset --force
```

### Problemas com Docker

```bash
# Parar containers
docker compose -f docker-compose-dev.yml down

# Remover volumes (cuidado: apaga dados)
docker compose -f docker-compose-dev.yml down -v
```

### Problemas com depend√™ncias

```bash
# Limpar cache do npm
npm cache clean --force

# Remover node_modules e reinstalar
rm -rf node_modules package-lock.json
npm install
```

## üìù Notas de Desenvolvimento

- A API utiliza soft delete (n√£o remove registros permanentemente)
- Todas as opera√ß√µes cr√≠ticas usam transa√ß√µes de banco
- Busca de produtos suporta normaliza√ß√£o de acentos
- Sistema de avalia√ß√µes com ratings de 1-5 estrelas
- Dashboard administrativo com estat√≠sticas completas

## üìÑ Licen√ßa

Este projeto est√° sob a licen√ßa MIT. Veja o arquivo [LICENSE](LICENSE) para mais detalhes.

---

**Desenvolvido com ‚ù§Ô∏è usando NestJS**
